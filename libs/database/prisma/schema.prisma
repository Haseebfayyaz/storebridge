generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  CUSTOMER
  VENDOR_ADMIN
  STORE_MANAGER
  DELIVERY
  ADMIN
  SUB_ADMIN
}

enum OrderStatus {
  ORDER_PLACED
  ACCEPTED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
  STRIPE
  WALLET
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED
  DELIVERED
  CANCELLED
}

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  COMMISSION
}

//////////////////////
// USER & AUTH
//////////////////////
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique // The hashed or unique UUID string
  userId    String
  tenantId  String
  
  // Metadata for Security
  userAgent String?  // Stores browser/device info (e.g., "Chrome on Windows")
  ipAddress String?  // Stores the login IP
  
  // Status & Expiry
  isRevoked Boolean  @default(false)
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model User {
  id         String    @id
  name       String
  email      String    @unique
  mobile     String?   @unique
  password   String?
  image      String?
  isBlocked  Boolean   @default(false)
  isVerified Boolean   @default(false)
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  createdAt  DateTime  @default(now())

  wallet     Wallet?
  addresses  Address[]
  ratings    Rating[]
  orders     Order[]    @relation("BuyerRelation")
  deliveries Delivery[]

  tenant       Tenant?
  managedStore Store?  @relation(fields: [storeId], references: [id])

  roles        UserRoleAssignment[] // NEW
  storeId      String?
  parentOrders ParentOrder[]
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[] 
}

//////////////////////
// TENANT
//////////////////////

model Tenant {
  id        String    @id @default(cuid())
  name      String
  country   String
  currency  String
  isActive  Boolean   @default(true)
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())

  ownerId String @unique
  owner   User   @relation(fields: [ownerId], references: [id])

  stores              Store[]
  products            Product[]
  warehouses          Warehouse[]
  roles               Role[]
  userRoleAssignments UserRoleAssignment[]
  refreshTokens RefreshToken[]
  taxClasses    TaxClass[]
  categories    Category[]
}

//////////////////////
// STORES (BRANCHES)
//////////////////////

model Store {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  name      String
  city      String
  country   String
  timezone  String
  latitude  Float?
  longitude Float?
  isActive  Boolean   @default(true)
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  createdAt DateTime  @default(now())

  tenant              Tenant               @relation(fields: [tenantId], references: [id])
  inventories         Inventory[]
  orders              Order[]
  managers            User[]
  commissions         Commission[]
  settlements         Settlement[]
  roles               Role[]
  userRoleAssignments UserRoleAssignment[]

  @@index([tenantId])
}

//////////////////////
// PRODUCT CATALOG (SHARED PER VENDOR)
//////////////////////

model Category {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  slug        String    // e.g., "dairy-products"
  
  // SELF-RELATION for Nesting
  parentId    String?   // The "Dairy" category would have "Grocery" as its parent
  parent      Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children    Category[] @relation("SubCategories")
  tenant      Tenant     @relation(fields: [tenantId], references: [id])

  products    Product[]
  
  @@unique([tenantId, slug]) // Prevent duplicate slugs within the same tenant
}

model Product {
  id          String    @id @default(cuid())
  tenantId    String    @map("tenant_id")
  name        String
  description String
   categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id])
  
  // TAX LOGIC
  // Connect to a TaxClass so "Grocery" and "Electronics" have different rates
  taxClassId  String?
  taxClass    TaxClass? @relation(fields: [taxClassId], references: [id])

  isActive    Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant     Tenant           @relation(fields: [tenantId], references: [id])
  variants ProductVariant[] // Every product has at least 1 variant
  ratings  Rating[]

  @@index([tenantId])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  sku       String   @unique
  barcode   String?  @unique // Critical for scanning handsfree/chargers
  
  // ATTRIBUTES
  // For Charger: these stay null. For Handsfree: "Red", "Blue", etc.
  color     String?
  size      String?
  weight    Float?
  weightUnit String? // e.g., "kg", "g"

  // GLOBAL/DEFAULT PRICING
  price     Float    // Default Selling Price
  costPrice Float    // Default Purchase Cost
  mrp       Float?   // Max Retail Price
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product              Product              @relation(fields: [productId], references: [id])
  inventories          Inventory[]          // Links to different stores
  orderItems           OrderItem[]
  warehouseInventories WarehouseInventory[]

  @@index([productId])
}

model Inventory {
  id          String   @id @default(cuid())
  storeId     String
  variantId   String
  
  // PER-STORE STOCK
  stockQty    Int      @default(0)
  reservedQty Int      @default(0)
  lowStock    Int      @default(5)

  // PER-STORE PRICING OVERRIDES
  // Use these if Store A is more expensive than Store B. 
  // If null, code falls back to ProductVariant price.
  storePrice     Float?   
  storeCostPrice Float?
  storeMrp       Float?

  updatedAt   DateTime @updatedAt

  store   Store          @relation(fields: [storeId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([storeId, variantId])
  @@index([storeId])
}

model TaxClass {
  id        String    @id @default(cuid())
  tenantId  String
  name      String    // e.g., "GST 18%", "Zero Rated"
  rate      Float     // e.g., 18.0
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  products  Product[]
}

//////////////////////
// WAREHOUSE (OPTIONAL)
//////////////////////

model Warehouse {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  name      String
  country   String
  createdAt DateTime @default(now())

  tenant    Tenant               @relation(fields: [tenantId], references: [id])
  inventory WarehouseInventory[]
}

model WarehouseInventory {
  id          String @id @default(cuid())
  warehouseId String
  variantId   String
  stockQty    Int

  warehouse Warehouse      @relation(fields: [warehouseId], references: [id])
  variant   ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([warehouseId, variantId])
}

//////////////////////
// ORDERS
//////////////////////

model ParentOrder {
  id        String   @id @default(cuid())
  userId    String
  total     Float
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  orders Order[]
}

model Order {
  id            String        @id @default(cuid())
  parentOrderId String?
  userId        String
  storeId       String
  total         Float
  status        OrderStatus   @default(ORDER_PLACED)
  paymentMethod PaymentMethod
  isPaid        Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  parentOrder ParentOrder? @relation(fields: [parentOrderId], references: [id])
  user        User         @relation("BuyerRelation", fields: [userId], references: [id])
  store       Store        @relation(fields: [storeId], references: [id])
  items       OrderItem[]
  delivery    Delivery?
  commission  Commission?

  @@index([storeId])
  @@index([userId])
}

model OrderItem {
  orderId   String
  variantId String
  quantity  Int
  price     Float

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@id([orderId, variantId])
}

//////////////////////
// DELIVERY
//////////////////////

model Delivery {
  id          String         @id @default(cuid())
  orderId     String         @unique
  riderId     String
  status      DeliveryStatus @default(PENDING)
  pickupTime  DateTime?
  deliveredAt DateTime?
  latitude    Float?
  longitude   Float?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  rider User  @relation(fields: [riderId], references: [id])
}

//////////////////////
// WALLET SYSTEM
//////////////////////

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Float    @default(0)
  createdAt DateTime @default(now())

  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id        String          @id @default(cuid())
  walletId  String
  type      TransactionType
  amount    Float
  reference String?
  createdAt DateTime        @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
}

//////////////////////
// COMMISSION & SETTLEMENT
//////////////////////

model Commission {
  id        String   @id @default(cuid())
  orderId   String   @unique
  storeId   String
  amount    Float
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id])
}

model Settlement {
  id          String    @id @default(cuid())
  storeId     String
  totalAmount Float
  isPaid      Boolean   @default(false)
  paidAt      DateTime?
  createdAt   DateTime  @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

//////////////////////
// COUPONS
//////////////////////

model Coupon {
  code        String   @id
  description String
  discount    Float
  isPublic    Boolean
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

//////////////////////
// ADDRESS
//////////////////////

model Address {
  id        String   @id @default(cuid())
  userId    String
  name      String
  email     String
  street    String
  city      String
  state     String
  zip       String
  country   String
  phone     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////
// RATING
//////////////////////

model Rating {
  id        String   @id @default(cuid())
  rating    Int
  review    String
  userId    String
  productId String
  orderId   String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, orderId])
}

//////////////////////
// AUDIT LOGS
//////////////////////

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

//////////////////////
// DYNAMIC RBAC SYSTEM
//////////////////////

model Role {
  id          String   @id @default(cuid())
  name        String
  description String?
  tenantId    String?  @map("tenant_id") // null = platform role
  storeId     String? // optional store-level role
  isSystem    Boolean  @default(false)
  createdAt   DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id])
  store  Store?  @relation(fields: [storeId], references: [id])

  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@index([tenantId])
  @@index([storeId])
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  module      String // orders, inventory, users, reports etc.
  createdAt   DateTime @default(now())

  roles RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRoleAssignment {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  tenantId  String?  @map("tenant_id")
  storeId   String?
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tenant Tenant? @relation(fields: [tenantId], references: [id])
  store  Store?  @relation(fields: [storeId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([storeId])
}
