generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR_ADMIN
  STORE_MANAGER
  DELIVERY
  ADMIN
  SUB_ADMIN
}

enum OrderStatus {
  ORDER_PLACED
  ACCEPTED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
  STRIPE
  WALLET
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED
  DELIVERED
  CANCELLED
}

enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  COMMISSION
}

model User {
  id             String   @id
  name           String
  email          String   @unique
  image          String?
  role           UserRole @default(CUSTOMER)
  isBlocked      Boolean  @default(false)
  isVerified     Boolean  @default(false)
  createdAt      DateTime @default(now())
  managedStoreId String?

  wallet         Wallet?
  addresses      Address[]
  ratings        Rating[]
  orders         Order[]          @relation("BuyerRelation")
  deliveries     Delivery[]
  vendorCompany  VendorCompany?
  managedStore   Store?           @relation(fields: [managedStoreId], references: [id])
  auditLogs      AuditLog[]
  parentOrders   ParentOrder[]
}

model VendorCompany {
  id         String      @id @default(cuid())
  name       String
  country    String
  currency   String
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  ownerId    String      @unique

  owner      User        @relation(fields: [ownerId], references: [id])
  stores     Store[]
  products   Product[]
  warehouses Warehouse[]
}

model Store {
  id           String      @id @default(cuid())
  vendorId     String
  name         String
  city         String
  country      String
  timezone     String
  latitude     Float?
  longitude    Float?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())

  vendor       VendorCompany @relation(fields: [vendorId], references: [id])
  inventories  Inventory[]
  orders       Order[]
  managers     User[]
  commissions  Commission[]
  settlements  Settlement[]

  @@index([vendorId])
}

model Product {
  id           String         @id @default(cuid())
  vendorId     String
  name         String
  description  String
  category     String
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  vendor       VendorCompany  @relation(fields: [vendorId], references: [id])
  variants     ProductVariant[]
  ratings      Rating[]

  @@index([vendorId])
}

model ProductVariant {
  id           String              @id @default(cuid())
  productId    String
  sku          String              @unique
  size         String?
  weight       String?
  price        Float
  mrp          Float?
  createdAt    DateTime            @default(now())

  product      Product             @relation(fields: [productId], references: [id])
  inventories  Inventory[]
  orderItems   OrderItem[]
  warehouseInventory WarehouseInventory[]

  @@index([productId])
}

model Inventory {
  id           String         @id @default(cuid())
  storeId      String
  variantId    String
  stockQty     Int
  reservedQty  Int            @default(0)
  lowStock     Int            @default(5)
  updatedAt    DateTime       @updatedAt

  store        Store          @relation(fields: [storeId], references: [id])
  variant      ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([storeId, variantId])
  @@index([storeId])
}

model Warehouse {
  id           String              @id @default(cuid())
  vendorId     String
  name         String
  country      String
  createdAt    DateTime            @default(now())

  vendor       VendorCompany       @relation(fields: [vendorId], references: [id])
  inventory    WarehouseInventory[]
}

model WarehouseInventory {
  id           String          @id @default(cuid())
  warehouseId  String
  variantId    String
  stockQty     Int

  warehouse    Warehouse       @relation(fields: [warehouseId], references: [id])
  variant      ProductVariant  @relation(fields: [variantId], references: [id])

  @@unique([warehouseId, variantId])
}

model ParentOrder {
  id           String      @id @default(cuid())
  userId       String
  total        Float
  createdAt    DateTime    @default(now())

  user         User        @relation(fields: [userId], references: [id])
  orders       Order[]
}

model Order {
  id            String        @id @default(cuid())
  parentOrderId String?
  userId        String
  storeId       String
  total         Float
  status        OrderStatus   @default(ORDER_PLACED)
  paymentMethod PaymentMethod
  isPaid        Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  parentOrder   ParentOrder?  @relation(fields: [parentOrderId], references: [id])
  user          User          @relation("BuyerRelation", fields: [userId], references: [id])
  store         Store         @relation(fields: [storeId], references: [id])
  items         OrderItem[]
  delivery      Delivery?
  commission    Commission?

  @@index([storeId])
  @@index([userId])
}

model OrderItem {
  orderId       String
  variantId     String
  quantity      Int
  price         Float

  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant       ProductVariant @relation(fields: [variantId], references: [id])

  @@id([orderId, variantId])
}

model Delivery {
  id            String         @id @default(cuid())
  orderId       String         @unique
  riderId       String
  status        DeliveryStatus @default(PENDING)
  pickupTime    DateTime?
  deliveredAt   DateTime?
  latitude      Float?
  longitude     Float?

  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  rider         User           @relation(fields: [riderId], references: [id])
}

model Wallet {
  id            String              @id @default(cuid())
  userId        String              @unique
  balance       Float               @default(0)
  createdAt     DateTime            @default(now())

  user          User                @relation(fields: [userId], references: [id])
  transactions  WalletTransaction[]
}

model WalletTransaction {
  id            String          @id @default(cuid())
  walletId      String
  type          TransactionType
  amount        Float
  reference     String?
  createdAt     DateTime        @default(now())

  wallet        Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
}

model Commission {
  id            String      @id @default(cuid())
  orderId       String      @unique
  storeId       String
  amount        Float
  createdAt     DateTime    @default(now())

  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  store         Store       @relation(fields: [storeId], references: [id])
}

model Settlement {
  id            String      @id @default(cuid())
  storeId       String
  totalAmount   Float
  isPaid        Boolean     @default(false)
  paidAt        DateTime?
  createdAt     DateTime    @default(now())

  store         Store       @relation(fields: [storeId], references: [id])
}

model Coupon {
  code          String      @id
  description   String
  discount      Float
  isPublic      Boolean
  expiresAt     DateTime
  createdAt     DateTime    @default(now())
}

model Address {
  id            String      @id @default(cuid())
  userId        String
  name          String
  email         String
  street        String
  city          String
  state         String
  zip           String
  country       String
  phone         String
  createdAt     DateTime    @default(now())

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Rating {
  id            String      @id @default(cuid())
  rating        Int
  review        String
  userId        String
  productId     String
  orderId       String
  createdAt     DateTime    @default(now())

  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, orderId])
}

model AuditLog {
  id            String      @id @default(cuid())
  userId        String
  action        String
  entity        String
  entityId      String
  createdAt     DateTime    @default(now())

  user          User        @relation(fields: [userId], references: [id])
}
